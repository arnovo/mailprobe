# Development with hot reload.
# Mac: Worker runs OUTSIDE Docker (port 25 blocked in Docker).
# Linux: Everything runs in Docker (use --profile linux to include worker).
# Usage: ./dev-start.sh
# Frontend at http://localhost:3002, API at http://localhost:8000.

services:
  backend:
    volumes:
      - ./backend:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Worker: on Mac runs outside Docker; on Linux activated with --profile linux
  worker:
    profiles:
      - linux  # Only starts with --profile linux (for Linux servers)
    volumes:
      - ./backend:/app
    command: ["/usr/local/bin/watchmedo", "auto-restart", "--directory=/app", "--pattern=*.py", "--recursive", "--", "celery", "-A", "app.tasks.celery_app", "worker", "-l", "info"]

  beat:
    volumes:
      - ./backend:/app
    command: ["/usr/local/bin/watchmedo", "auto-restart", "--directory=/app", "--pattern=*.py", "--recursive", "--", "celery", "-A", "app.tasks.celery_app", "beat", "-l", "info"]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      # Next/webpack cache in volume to avoid ENOENT/rename on host mount
      - frontend_next:/app/.next
      - frontend_node_modules:/app/node_modules
    ports:
      - "3002:3001"
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:8000
    # Install deps (if needed) and start dev with hot reload on 0.0.0.0
    command: ["sh", "-c", "npm install --include=dev && npm run dev -- -H 0.0.0.0"]

volumes:
  frontend_node_modules:
  frontend_next:
