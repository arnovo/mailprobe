---
description: Main project rules for Mailprobe
alwaysApply: true
---

# Mailprobe - Project Guide

## Tech Stack

- **Backend**: FastAPI + SQLAlchemy (async) + PostgreSQL + Celery + Redis
- **Frontend**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Infrastructure**: Docker Compose (dev and prod)

## Architecture

```
backend/
  app/
    api/v1/      # REST endpoints (FastAPI routers)
    core/        # Config, database, security
    models/      # SQLAlchemy ORM models
    schemas/     # Pydantic schemas (request/response)
    services/    # Business logic
    tasks/       # Celery tasks (async background)
frontend/
  src/app/       # Next.js App Router (pages)
  src/lib/       # Shared utilities
```

## Important Technical Decisions

1. **Worker outside Docker on Mac**: Port 25 (SMTP) is blocked in Docker Desktop macOS. Use `./dev-start.sh` which detects the OS automatically.

2. **Per-workspace configuration**: Dynamic settings in `workspace_config_entries` table (key/value). No migrations needed for new options.

3. **Logs with visibility**: `JobLogLine.visibility` can be `public` or `superadmin`. Detailed SMTP logs are superadmin only.

4. **Email verification**: Flow MX → SMTP RCPT TO → Catch-all → SPF/DMARC → Web search (optional).

5. **Web search**: Configurable per workspace (Serper.dev or Bing). API key in workspace config, not in .env.

## Code Conventions

- **Code language**: English (variables, functions, classes)
- **UI/user logs language**: Based on user locale (i18n)
- **Commits**: Conventional Commits in English (see `commit-messages.mdc` rule)
- **No automatic commits**: Only when the user explicitly requests

## Database

- Migrations with **Alembic** (numeric prefix: `001_`, `002_`, etc.)
- Models in `backend/app/models/`
- Use `AsyncSession` in endpoints, sync `Session` in Celery tasks
