---
description: Main project rules for Mailprobe
alwaysApply: true
---

# Mailprobe - Project Guide

## Tech Stack

- **Backend**: FastAPI + SQLAlchemy (async) + PostgreSQL + Celery + Redis
- **Frontend**: Next.js 14 (App Router) + TypeScript + Tailwind CSS
- **Infrastructure**: Docker Compose (dev and prod)

## Architecture

```
backend/
  app/
    api/v1/      # REST endpoints (FastAPI routers)
    core/        # Config, database, security
    models/      # SQLAlchemy ORM models
    schemas/     # Pydantic schemas (request/response)
    services/    # Business logic
    tasks/       # Celery tasks (async background)
frontend/
  src/app/       # Next.js App Router (pages)
  src/lib/       # Shared utilities
```

## Important Technical Decisions

1. **Worker outside Docker on Mac**: Port 25 (SMTP) is blocked in Docker Desktop macOS. Use `./dev-start.sh` which detects the OS automatically.

2. **Per-workspace configuration**: Dynamic settings in `workspace_config_entries` table (key/value). No migrations needed for new options.

3. **Logs with visibility**: `JobLogLine.visibility` can be `public` or `superadmin`. Detailed SMTP logs are superadmin only.

4. **Email verification**: Flow MX → SMTP RCPT TO → Catch-all → SPF/DMARC → Web search (optional).

5. **Web search**: Configurable per workspace (Serper.dev or Bing). API key in workspace config, not in .env.

## Code Conventions

- **Code language**: English (variables, functions, classes)
- **UI/user logs language**: Based on user locale (i18n)
- **Commits**: Conventional Commits in English (see `commit-messages.mdc` rule)
- **No automatic commits**: Only when the user explicitly requests

## No Magic Values

**Never use magic strings, magic numbers, or hardcoded values directly in code.**

All literal values must be extracted to named constants:

```python
# ❌ Bad - magic values
if status == "pending":
    timeout = 30
    
# ✅ Good - named constants
STATUS_PENDING = "pending"
DEFAULT_TIMEOUT_SECONDS = 30

if status == STATUS_PENDING:
    timeout = DEFAULT_TIMEOUT_SECONDS
```

### Where to Place Constants

| Scope | Location |
|-------|----------|
| **Shared across modules** | Global constants file (`backend/app/core/constants.py`, `frontend/src/lib/constants.ts`) |
| **Used only in one module** | Constants at the top of that specific file |
| **Domain-specific** | Dedicated file in context folder (e.g., `verification/constants.py`) |

### Examples

```python
# backend/app/core/constants.py (global)
HTTP_STATUS_OK = 200
DEFAULT_PAGE_SIZE = 50
CACHE_TTL_SECONDS = 3600

# backend/app/services/verification/constants.py (domain)
SMTP_TIMEOUT_SECONDS = 10
MAX_RETRY_ATTEMPTS = 3
VERIFICATION_STATUS_VALID = "valid"
VERIFICATION_STATUS_INVALID = "invalid"

# In a specific file (local, top of file)
MAX_BATCH_SIZE = 100  # Only used in this module
```

### What Counts as Magic Values

- Status strings: `"pending"`, `"completed"`, `"failed"`
- Numeric limits: `100`, `30`, `3600`
- Configuration keys: `"smtp_timeout"`, `"api_key"`
- Error messages (use error codes instead)
- API endpoints, URLs
- Regex patterns

## Database

- Migrations with **Alembic** (numeric prefix: `001_`, `002_`, etc.)
- Models in `backend/app/models/`
- Use `AsyncSession` in endpoints, sync `Session` in Celery tasks
