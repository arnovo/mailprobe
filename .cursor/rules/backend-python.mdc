---
description: Python standards for the FastAPI backend
globs: backend/**/*.py
alwaysApply: false
---

# Backend Python - Standards

## SOLID Principles

1. **Single Responsibility**: Each module/class has only one reason to change
   - `services/` = business logic
   - `api/v1/` = only routing and HTTP validation
   - `models/` = only ORM definition
   - `schemas/` = only Pydantic validation

2. **Open/Closed**: Extend behavior without modifying existing code
   - Use per-workspace configuration instead of hardcoding

3. **Dependency Inversion**: Inject dependencies (db session, config)

## File Structure

```python
# api/v1/leads.py - Endpoint
@router.get("/")
async def list_leads(db: AsyncSession = Depends(get_db)):
    ...

# services/verifier.py - Business logic
def verify_email(email: str, config: dict) -> VerificationResult:
    ...

# models/lead.py - ORM Model
class Lead(Base):
    __tablename__ = "leads"
    ...

# schemas/lead.py - Validation
class LeadCreate(BaseModel):
    ...
```

## Naming Conventions

- **Files**: snake_case (`email_patterns.py`, `workspace_config.py`)
- **Classes**: PascalCase (`Lead`, `JobLogLine`, `WorkspaceConfigEntry`)
- **Functions/variables**: snake_case (`verify_email`, `get_workspace_config`)
- **Constants**: UPPER_SNAKE (`CONFIG_KEYS`, `FIRST_ONLY_PATTERNS`)

## Async vs Sync

```python
# FastAPI endpoints: ALWAYS async
async def get_lead(db: AsyncSession = Depends(get_db)):
    result = await db.execute(select(Lead))

# Celery tasks: sync (uses Session, not AsyncSession)
def verify_lead_task(lead_id: int):
    with SessionLocal() as db:
        lead = db.query(Lead).get(lead_id)
```

## Error Handling

```python
# ❌ BAD
try:
    result = do_something()
except:
    pass

# ✅ GOOD
try:
    result = do_something()
except SpecificError as e:
    logger.error(f"Operation error: {e}")
    raise HTTPException(status_code=400, detail=str(e))
```

## Logging

```python
# Public logs (visible to user)
add_log_line(job, "Verifying email...", visibility="public")

# Technical logs (superadmin only)
add_log_line(job, f"SMTP response: {code}", visibility="superadmin")
```
